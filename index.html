<!DOCTYPE html>
<html>
<head>
    <title>ì¡°ì„ ì‹œëŒ€ ëŸ¬ë¸Œë ˆí„°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { text-align: center; font-family: 'Noto Sans KR', sans-serif; background-color: #2e2b26; color: #f0e6d2; margin: 0; padding: 0; overflow: hidden; }
        #login-screen { display: flex; flex-direction: column; justify-content: center; height: 100vh; align-items: center; }
        input { padding: 15px; font-size: 20px; border-radius: 5px; border: 2px solid #8c7b6c; background-color: #4a4036; color: white; text-align: center; margin-bottom: 20px; width: 80%; max-width: 300px; }
        .btn-custom { padding: 15px 30px; font-size: 22px; background-color: #a63737; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #game-screen { display: none; max-width: 600px; margin: 0 auto; padding: 10px; height: 100vh; flex-direction: column; box-sizing: border-box; }
        #top-bar { display: flex; flex-direction: column; background: rgba(0,0,0,0.4); border-radius: 10px; margin-bottom: 5px; padding: 10px; border: 1px solid #5c5042; }
        #game-log { background: rgba(0,0,0,0.3); height: 15vh; overflow-y: auto; padding: 10px; border-radius: 10px; font-size: 13px; margin-bottom: 5px; text-align: left; border: 1px solid #5c5042; }
        #hand-container { display: flex; justify-content: center; gap: 10px; flex: 1; align-items: center; }
        .card { background: #f5f0e1; color: #2e2b26; width: 140px; height: 210px; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 4px solid #d4c5a9; cursor: pointer; font-weight: bold; font-size: 20px; }
        .card.disabled { opacity: 0.5; filter: grayscale(1); }
        #mini-card-area { background: rgba(0,0,0,0.2); border-radius: 10px; padding: 10px; margin-top: auto; }
        .mini-card-wrap { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; }
        .mini-card { width: 22%; height: 50px; background: #5c5042; color: #e0d0b8; border-radius: 5px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; border: 1px solid #3d342b; }
        .mini-card.out { background: #2b2520; color: #555; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        .overlay-btn { padding: 12px; margin: 5px; width: 80%; background: #4a4036; color: white; border: 1px solid #8c7b6c; border-radius: 5px; font-size: 16px; }
    </style>
</head>
<body>
    <div id="login-screen">
        <h1 style="color: #e6b322; font-family: 'Gungsuh';">ì¡°ì„ ì‹œëŒ€ ëŸ¬ë¸Œë ˆí„°</h1>
        <input type="text" id="nickname" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì‹œì˜¤" />
        <button class="btn-custom" onclick="joinGame()">ì…ì¥í•˜ê¸°</button>
    </div>

    <div id="game-screen">
        <div id="top-bar">
            <div style="display: flex; justify-content: space-between;">
                <span id="room-info-display">ëŒ€ê¸°ì‹¤ (<span id="player-count">0</span>/4)</span>
                <button id="start-btn" onclick="requestStart()" style="display:none; background:#3e6b46; color:white; border:none; padding:5px 10px;">ê²Œì„ ì‹œì‘</button>
            </div>
            <div id="player-names-box" style="font-size:12px; margin-top:5px; color:#9c8e7e;"></div>
        </div>
        <div id="game-log"></div>
        <div id="turn-info" style="color:#e6b322; margin-bottom:10px;">ëŒ€ê¸° ì¤‘...</div>
        <div id="hand-container">
            <div class="card disabled" id="card0" onclick="clickCard(0)"></div>
            <div class="card disabled" id="card1" onclick="clickCard(1)"></div>
        </div>
        <div id="mini-card-area">
            <div id="mini-card-container" class="mini-card-wrap"></div>
        </div>
    </div>

    <div id="target-overlay" class="overlay">
        <h2 style="color: #f0e6d2;">ëŒ€ìƒì„ ì„ íƒí•˜ì‹œì˜¤</h2>
        <div id="target-buttons" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
        <button class="overlay-btn" style="background:#222;" onclick="closeOverlay()">ì·¨ì†Œ</button>
    </div>

    <div id="guess-overlay" class="overlay">
        <h2 style="color: #f0e6d2;">ìƒëŒ€ì˜ ì¹´ë“œëŠ”?</h2>
        <div id="guess-buttons" style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; width:80%;">
            <button class="overlay-btn" onclick="submitPlay('2')">ê´‘ëŒ€(2)</button>
            <button class="overlay-btn" onclick="submitPlay('3')">ê²€ê°(3)</button>
            <button class="overlay-btn" onclick="submitPlay('4')">ì˜ë…€(4)</button>
            <button class="overlay-btn" onclick="submitPlay('5')">ìê°(5)</button>
            <button class="overlay-btn" onclick="submitPlay('6')">ì„ê¸ˆ(6)</button>
            <button class="overlay-btn" onclick="submitPlay('7')">í›„ê¶(7)</button>
            <button class="overlay-btn" onclick="submitPlay('8')">ì™•ë¹„(8)</button>
        </div>
        <button class="overlay-btn" style="background:#222;" onclick="closeOverlay()">ì·¨ì†Œ</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myName = "", myHand = [], isMyTurn = false, selectedCard = "", players = [];

        function joinGame() {
            myName = document.getElementById('nickname').value;
            if(!myName) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì‹œì˜¤!");
            socket.emit('login', { name: myName });
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
        }

        function requestStart() { socket.emit('requestStart'); }

        socket.on('updateHand', (hand) => {
            myHand = hand;
            for(let i=0; i<2; i++) {
                const el = document.getElementById('card' + i);
                if(myHand[i]) { el.innerText = myHand[i]; el.classList.remove('disabled'); }
                else { el.innerText = "ì—†ìŒ"; el.classList.add('disabled'); }
            }
        });

        socket.on('roomInfo', (data) => {
            players = data.playerStates;
            document.getElementById('player-count').innerText = data.count;
            document.getElementById('start-btn').style.display = (data.count >= 2 && !data.isStarted) ? 'block' : 'none';
            document.getElementById('player-names-box').innerHTML = data.playerStates.map(p => 
                `<span style="${p.isEliminated ? 'text-decoration:line-through;color:red;' : ''}">${p.name}</span>`
            ).join(" | ");
        });

        socket.on('turnUpdate', (data) => {
            isMyTurn = (data.turnName === myName);
            document.getElementById('turn-info').innerText = isMyTurn ? "ğŸ”´ ë‹¹ì‹ ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤!" : `âŒ› ${data.turnName}ì˜ ì°¨ë¡€...`;
        });

        socket.on('gameLog', (msg) => {
            const log = document.getElementById('game-log');
            log.innerHTML += `<div>${msg}</div>`;
            log.scrollTop = log.scrollHeight;
        });

        socket.on('privateNotice', (msg) => alert(msg));

        function clickCard(idx) {
            if(!isMyTurn || !myHand[idx]) return;
            selectedCard = myHand[idx];
            
            if((selectedCard.includes("ìê°") || selectedCard.includes("ì„ê¸ˆ")) && myHand.some(c => c.includes("í›„ê¶"))) {
                return alert("í›„ê¶(7)ì´ ìˆì„ ë•ŒëŠ” ì´ ì¹´ë“œë¥¼ ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
            }

            const targets = ["í¬ì¡¸", "ê´‘ëŒ€", "ê²€ê°", "ìê°", "ì„ê¸ˆ"];
            if(targets.some(t => selectedCard.includes(t))) {
                const container = document.getElementById('target-buttons');
                container.innerHTML = "";
                players.forEach(p => {
                    if(!p.isEliminated && p.name !== myName) {
                        const btn = document.createElement('button');
                        btn.className = "overlay-btn";
                        btn.innerText = p.name;
                        btn.onclick = () => selectTarget(p.name);
                        container.appendChild(btn);
                    }
                });
                // ì˜ˆì™¸: íƒ€ê²Ÿ ì¡ì„ ìƒëŒ€ê°€ ì—†ìœ¼ë©´ ìì‹ ì„ ì„ íƒí•˜ê±°ë‚˜ ë¬´íš¨ì²˜ë¦¬ (ëŸ¬ë¸Œë ˆí„° ê·œì¹™)
                if(container.innerHTML === "") selectTarget(myName); 
                else document.getElementById('target-overlay').style.display = 'flex';
            } else {
                submitPlay();
            }
        }

        let selectedTarget = "";
        function selectTarget(name) {
            selectedTarget = name;
            document.getElementById('target-overlay').style.display = 'none';
            if(selectedCard.includes("í¬ì¡¸")) document.getElementById('guess-overlay').style.display = 'flex';
            else submitPlay();
        }

        function submitPlay(guess = "") {
            socket.emit('playCard', { card: selectedCard, target: selectedTarget, guess: guess });
            closeOverlay();
        }

        function closeOverlay() {
            document.querySelectorAll('.overlay').forEach(o => o.style.display = 'none');
        }

        socket.on('updateCardStats', (stats) => {
            document.getElementById('mini-card-container').innerHTML = stats.map(s => `
                <div class="mini-card ${s.remaining === 0 ? 'out' : ''}">
                    <b>${s.name}(${s.num})</b>
                    <span>${s.remaining}/${s.total}</span>
                </div>
            `).join("");
        });
    </script>
</body>
</html>
