<!DOCTYPE html>
<html>
<head>
    <title>ì¤‘ì „êµ¬ì¶œ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { text-align: center; font-family: 'Noto Sans KR', sans-serif; background-color: #2e2b26; color: #f0e6d2; margin: 0; padding: 0; overflow: hidden; }
        #login-screen { display: flex; flex-direction: column; justify-content: center; height: 100vh; align-items: center; }
        input { padding: 15px; font-size: 20px; border-radius: 5px; border: 2px solid #8c7b6c; background-color: #4a4036; color: white; text-align: center; margin-bottom: 20px; width: 80%; max-width: 300px; }
        .btn-custom { padding: 15px 30px; font-size: 22px; background-color: #a63737; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.4); width: 80%; max-width: 300px; margin-bottom: 10px; box-sizing: border-box; }
        .btn-sub { background-color: #5c5042; }
        #game-screen { display: none; max-width: 600px; margin: 0 auto; padding: 10px; height: 100vh; flex-direction: column; box-sizing: border-box; }
        #top-bar { display: flex; flex-direction: column; background: rgba(0,0,0,0.4); border-radius: 10px; margin-bottom: 5px; padding: 10px; border: 1px solid #5c5042; }
        #game-log { background: rgba(0,0,0,0.3); height: 18vh; overflow-y: auto; padding: 10px; border-radius: 10px; font-size: 14px; margin-bottom: 5px; text-align: left; border: 1px solid #5c5042; }
        #hand-container { display: flex; justify-content: center; gap: 10px; flex: 1; align-items: center; }
        .card { background: #f5f0e1; color: #2e2b26; width: 150px; height: 230px; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 4px solid #d4c5a9; cursor: pointer; text-align: center; padding: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.6); box-sizing: border-box; pointer-events: auto; }
        .card-name { font-size: 22px; margin-bottom: 8px; font-family: "Gungsuh", serif; font-weight: bold; pointer-events: none; }
        .card-desc { font-size: 12px; line-height: 1.3; color: #333; pointer-events: none; }
        .card.active { border-color: #a63737; transform: scale(1.05); }
        .card.disabled { opacity: 0.5; filter: grayscale(1); cursor: default; pointer-events: none; }
        #mini-card-area { background: rgba(0,0,0,0.2); border-radius: 10px; padding: 10px 8px; margin-top: auto; border: 1px solid #5c5042; }
        .mini-card-wrap { display: flex; flex-wrap: wrap; justify-content: center; gap: 6px; }
        .mini-card { width: 22%; height: 75px; background: #5c5042; color: #e0d0b8; border-radius: 5px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; border: 1px solid #3d342b; }
        .mini-card.sold-out { background: #1a1a1a; color: #555; opacity: 0.6; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        .overlay-btn { padding: 15px; margin: 5px; width: 85%; max-width: 250px; background: #4a4036; color: white; border: 1px solid #8c7b6c; border-radius: 5px; font-size: 18px; }
        #retry-btn { display: none; background: #ffeb3b; color: #000; border: 3px solid #fbc02d; border-radius: 8px; padding: 8px 16px; font-size: 19px; font-weight: 900; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 235, 59, 0.4); margin-top: 5px; width: auto; max-width: none; }
        #notice-box { background: #f5f0e1; color: #2e2b26; padding: 25px; border-radius: 10px; width: 85%; max-width: 350px; border: 5px solid #a63737; max-height: 80vh; overflow-y: auto; text-align: left; }
    </style>
</head>
<body>
    <div id="login-screen">
        <div style="font-size: 80px; margin-bottom: 10px; text-align: center;">ğŸ‘¸</div>
        <h1 style="color: #e6b322; font-size: 45px; font-family: 'Gungsuh'; margin-bottom: 5px; margin-top: 0;">ì¤‘ì „êµ¬ì¶œ</h1>
        <div style="font-size: 22.5px; color: #888; margin-bottom: 30px;">(ì›ì‘.ëŸ¬ë¸Œë ˆí„°)</div>
        <input type="text" id="nickname" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì‹œì˜¤" />
        <button class="btn-custom" onclick="joinGame()">ì…ì¥í•˜ê¸°</button>
        <button class="btn-custom btn-sub" onclick="showRule()">ê²Œì„ë°©ë²•</button>
    </div>

    <div id="game-screen">
        <div id="top-bar">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 14px;">ì¸ì›: <span id="player-count">0</span>/4</span>
                <div>
                    <button id="start-btn" class="btn-custom" onclick="requestStart()" style="display:none; padding:8px 15px; font-size:16px; width: auto;">â–¶ ì‹œì‘í•˜ê¸°</button>
                    <button id="retry-btn" onclick="requestStart()">í•œ íŒ ë”!</button>
                </div>
            </div>
            <div id="player-names-box" style="font-size:12px; margin-top:5px; text-align:left; color:#9c8e7e;"></div>
        </div>
        <div id="game-log"></div>
        <div id="turn-info" style="color:#e6b322; font-weight:bold; font-size: 18px; margin: 5px 0;">ì…ì¥ ì™„ë£Œ</div>
        <div id="hand-container">
            <div class="card disabled" id="card0" onclick="clickCard(0)"></div>
            <div class="card disabled" id="card1" onclick="clickCard(1)"></div>
        </div>
        <div id="mini-card-area">
            <div id="deck-status" style="font-size:11px; color:#e6b322; margin-bottom:8px;">í˜„ì¬ê¹Œì§€ ê³µê°œëœ ì¹´ë“œ (ë‚¨ì€ ë±: -ì¥)</div>
            <div id="mini-card-container" class="mini-card-wrap"></div>
        </div>
    </div>

    <div id="target-overlay" class="overlay">
        <h2 style="color: #f0e6d2;">ëŒ€ìƒ í”Œë ˆì´ì–´ ì„ íƒ</h2>
        <div id="target-buttons" style="display:flex; flex-direction:column; align-items:center; width:100%;"></div>
        <button class="overlay-btn" style="background:#333;" onclick="closeOverlay()">ì·¨ì†Œ</button>
    </div>

    <div id="guess-overlay" class="overlay">
        <h2 style="color: #f0e6d2;">ìƒëŒ€ì˜ íŒ¨ëŠ”?</h2>
        <div id="guess-buttons" style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; width:85%;">
            <button class="overlay-btn" onclick="submitPlay('2')">ğŸ”®ë¬´ë‹¹(2)</button>
            <button class="overlay-btn" onclick="submitPlay('3')">âš”ï¸ê²€ê°(3)</button>
            <button class="overlay-btn" onclick="submitPlay('4')">ğŸ©ºì˜ë…€(4)</button>
            <button class="overlay-btn" onclick="submitPlay('5')">ğŸ¤´ì„¸ì(5)</button>
            <button class="overlay-btn" onclick="submitPlay('6')">ğŸ‘‘ì„ê¸ˆ(6)</button>
            <button class="overlay-btn" onclick="submitPlay('7')">ğŸŒ¸í›„ê¶(7)</button>
            <button class="overlay-btn" onclick="submitPlay('8')">ğŸ‘¸ì¤‘ì „(8)</button>
        </div>
    </div>

    <div id="notice-overlay" class="overlay">
        <div id="notice-box">
            <div id="notice-msg"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn-custom" style="font-size: 16px; padding: 10px 30px; width: auto;" onclick="closeNotice()">í™•ì¸</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myName = "", myHand = [], isMyTurn = false, isEliminated = false, selectedCard = "", players = [], selectedTarget = "";
        
        const cardInfo = {
            "1": { emoji: "ğŸ‘®â€â™‚ï¸", name: "í¬ì¡¸", desc: "ìƒëŒ€ 1ëª…ì„ ì§€ëª©í•˜ê³  ì¹´ë“œ ì¢…ë¥˜ë¥¼ ë§í™ë‹ˆë‹¤. ë§íˆë©´ íƒˆë½(1 ì œì™¸)" },
            "2": { emoji: "ğŸ”®", name: "ë¬´ë‹¹", desc: "ìƒëŒ€ 1ëª…ì˜ íŒ¨ë¥¼ í™•ì¸í•©ë‹ˆë‹¤." },
            "3": { emoji: "âš”ï¸", name: "ê²€ê°", desc: "ìƒëŒ€ 1ëª…ê³¼ íŒ¨ë¥¼ ë¹„êµí•©ë‹ˆë‹¤. ìˆ«ìê°€ ë‚®ì€ ì‚¬ëŒì€ íƒˆë½í•©ë‹ˆë‹¤." },
            "4": { emoji: "ğŸ©º", name: "ì˜ë…€", desc: "ë‹¤ìŒ ìì‹ ì˜ í„´ê¹Œì§€ ë‹¤ë¥¸ ì¹´ë“œì˜ íš¨ê³¼ë¥¼ ë°›ì§€ ì•ŠìŠµë‹ˆë‹¤." },
            "5": { emoji: "ğŸ¤´", name: "ì„¸ì", desc: "ìì‹  ë˜ëŠ” íƒ€ì¸ì˜ íŒ¨ë¥¼ ë²„ë¦¬ê²Œ í•˜ê³  ìƒˆ ì¹´ë“œë¥¼ ë½‘ê²Œ í•©ë‹ˆë‹¤. (ì¤‘ì „ì´ë©´ íƒˆë½)" },
            "6": { emoji: "ğŸ‘‘", name: "ì„ê¸ˆ", desc: "ìƒëŒ€ 1ëª…ê³¼ íŒ¨ë¥¼ ì„œë¡œ êµí™˜í•©ë‹ˆë‹¤." },
            "7": { emoji: "ğŸŒ¸", name: "í›„ê¶", desc: "ì„¸ì(5) ë˜ëŠ” ì„ê¸ˆ(6)ì„ í•¨ê»˜ ë“¤ê³  ìˆì„ ê²½ìš° ë°˜ë“œì‹œ ë²„ë ¤ì•¼ í•©ë‹ˆë‹¤." },
            "8": { emoji: "ğŸ‘¸", name: "ì¤‘ì „", desc: "ì´ ì¹´ë“œë¥¼ ë²„ë¦¬ë©´ ì¦‰ì‹œ íƒˆë½í•©ë‹ˆë‹¤." }
        };

        function showNotice(msg, isRichText = false) { 
            const msgEl = document.getElementById('notice-msg');
            if(isRichText) msgEl.innerHTML = msg;
            else msgEl.innerText = msg;
            document.getElementById('notice-overlay').style.display = 'flex'; 
        }
        function closeNotice() { document.getElementById('notice-overlay').style.display = 'none'; }
        
        function showRule() {
            const ruleText = `
                <h3 style="color:#a63737; border-bottom:2px solid #a63737; padding-bottom:5px;">ğŸ° ê²Œì„ ìŠ¤í† ë¦¬</h3>
                <p style="font-size:13px; line-height:1.6;">ì¤‘ì „ì´ ëª¨í•¨ì„ ë°›ì•„ ì–µìš¸í•˜ê²Œ ê°ì˜¥ì— ê°‡í˜”ìŠµë‹ˆë‹¤. ë‹¹ì‹ ì€ ë¹„ë°€ êµ¬ì¶œ ì„¸ë ¥ì˜ ì¼ì›ì´ ë˜ì–´ ê¶ì¤‘ ì¸ë¬¼ë“¤ì˜ ë„ì›€ì„ ë°›ì•„ ì¤‘ì „ì— ê°€ì¥ ë¨¼ì € ë„ë‹¬í•´ì•¼ í•©ë‹ˆë‹¤.</p>
                
                <h3 style="color:#a63737; border-bottom:2px solid #a63737; padding-bottom:5px; margin-top:20px;">ğŸ“œ ê²Œì„ ì¹´ë“œ ê¸°ëŠ¥</h3>
                <ul style="font-size:13px; padding-left:20px; line-height:1.8;">
                    <li><b>1 í¬ì¡¸ ğŸ‘®â€â™‚ï¸:</b> ìƒëŒ€ íŒ¨ ë§ì¶”ê¸° (ì„±ê³µ ì‹œ ìƒëŒ€ íƒˆë½)</li>
                    <li><b>2 ë¬´ë‹¹ ğŸ”®:</b> ìƒëŒ€ íŒ¨ ëª°ë˜ í™•ì¸</li>
                    <li><b>3 ê²€ê° âš”ï¸:</b> íŒ¨ ë¹„êµ (ë‚®ì€ ìˆ«ì íƒˆë½)</li>
                    <li><b>4 ì˜ë…€ ğŸ©º:</b> ë‹¤ìŒ í„´ê¹Œì§€ íš¨ê³¼ ë¬´ì‹œ (ë³´í˜¸)</li>
                    <li><b>5 ì„¸ì ğŸ¤´:</b> íŒ¨ ë²„ë¦¬ê³  ìƒˆë¡œ ë½‘ê¸° (ì¤‘ì „ ë²„ë¦¬ë©´ íƒˆë½)</li>
                    <li><b>6 ì„ê¸ˆ ğŸ‘‘:</b> ìƒëŒ€ì™€ íŒ¨ êµí™˜</li>
                    <li><b>7 í›„ê¶ ğŸŒ¸:</b> ì„¸ì/ì„ê¸ˆê³¼ í•¨ê»˜ ìˆìœ¼ë©´ ê°•ì œ ë²„ë¦¼</li>
                    <li><b>8 ì¤‘ì „ ğŸ‘¸:</b> ë²„ë¦¬ë©´ ì¦‰ì‹œ íƒˆë½</li>
                </ul>

                <h3 style="color:#a63737; border-bottom:2px solid #a63737; padding-bottom:5px; margin-top:20px;">ğŸ® ê²Œì„ ì§„í–‰</h3>
                <p style="font-size:13px; line-height:1.6;">
                    1. ì¹´ë“œ 1ì¥ì„ ë½‘ìŠµë‹ˆë‹¤. (ì†ì— 2ì¥)<br>
                    2. 1ì¥ì„ ì„ íƒí•´ ì‚¬ìš©í•˜ê³  íš¨ê³¼ë¥¼ ì ìš©í•©ë‹ˆë‹¤.<br>
                    3. ë±ì´ ì†Œì§„ë˜ê±°ë‚˜ í•œ ëª…ë§Œ ë‚¨ìœ¼ë©´ ì¢…ë£Œë©ë‹ˆë‹¤.<br>
                    4. ë§ˆì§€ë§‰ì— ê°€ì¥ ë†’ì€ ìˆ«ìë¥¼ ê°€ì§„ ì‚¬ëŒì´ ìŠ¹ë¦¬!
                </p>
            `;
            showNotice(ruleText, true);
        }

        function joinGame() {
            myName = document.getElementById('nickname').value;
            if(!myName) return showNotice("ì´ë¦„ì„ ì…ë ¥í•˜ì‹œì˜¤!");
            socket.emit('login', { name: myName });
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
        }

        function requestStart() {
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('retry-btn').style.display = 'none';
            socket.emit('requestStart');
        }

        socket.on('gameStartedNotice', () => {
            isEliminated = false;
            const turnInfo = document.getElementById('turn-info');
            turnInfo.style.color = "#4CAF50";
            turnInfo.innerText = "âœ¨ ìƒˆë¡œìš´ ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!";
            setTimeout(() => { if (turnInfo.innerText.includes("ìƒˆë¡œìš´ ê²Œì„")) turnInfo.style.color = "#e6b322"; }, 3000);
        });

        socket.on('updateHand', (hand) => {
            myHand = hand;
            updateHandUI();
        });

        function updateHandUI() {
            for(let i=0; i<2; i++) {
                const el = document.getElementById('card' + i);
                if(myHand[i]) {
                    const num = myHand[i].match(/\d+/)[0];
                    el.innerHTML = `<div class="card-name">${cardInfo[num].emoji}${cardInfo[num].name}(${num})</div><div class="card-desc">${cardInfo[num].desc}</div>`;
                    el.classList.remove('disabled');
                    if(isMyTurn) el.classList.add('active');
                    else el.classList.remove('active');
                } else { el.innerHTML = "íŒ¨ ì—†ìŒ"; el.classList.add('disabled'); el.classList.remove('active'); }
            }
        }

        socket.on('roomInfo', (data) => {
            players = data.playerStates;
            document.getElementById('player-count').innerText = data.count;
            const me = data.playerStates.find(p => p.name === myName);
            if (me) isEliminated = me.isEliminated;
            const sBtn = document.getElementById('start-btn');
            const rBtn = document.getElementById('retry-btn');
            if(data.count >= 2 && !data.isStarted) { if(rBtn.style.display !== 'block') sBtn.style.display = 'block'; }
            else sBtn.style.display = 'none';
            document.getElementById('player-names-box').innerHTML = data.playerStates.map(p => `<span style="${p.isEliminated ? 'text-decoration:line-through;color:red;' : ''}">${p.name}</span>`).join(" | ");
            if(isEliminated && data.isStarted && !document.getElementById('turn-info').innerText.includes("âœ¨")) {
                document.getElementById('turn-info').innerHTML = `<span style="color:#ff5252;">ğŸ’€ ${myName} íŒ¨ë°°! (ê´€ì „ ì¤‘...)</span>`;
            }
        });

        socket.on('gameOver', (data) => {
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('retry-btn').style.display = 'block';
            document.getElementById('turn-info').innerHTML = `<span style="color:#ffeb3b; font-size:24px;">ğŸ† ìµœì¢… ìŠ¹ë¦¬ì: ${data.winnerName}</span>`;
            isMyTurn = false;
            updateHandUI();
        });

        socket.on('turnUpdate', (data) => {
            document.getElementById('retry-btn').style.display = 'none';
            isMyTurn = (data.turnId === socket.id);
            const turnInfo = document.getElementById('turn-info');
            if(!isEliminated) {
                turnInfo.style.color = "#e6b322";
                turnInfo.innerText = isMyTurn ? "ğŸ”´ ë‹¹ì‹ ì˜ ì°¨ë¡€!" : `âŒ› ${data.turnName}ì˜ ì°¨ë¡€...`;
            } else { turnInfo.innerHTML = `<span style="color:#ff5252;">ğŸ’€ ${myName} íŒ¨ë°°! (ê´€ì „ ì¤‘...)</span>`; }
            updateHandUI();
        });

        socket.on('gameLog', (msg) => {
            const log = document.getElementById('game-log');
            log.innerHTML += `<div>${msg}</div>`;
            log.scrollTop = log.scrollHeight;
        });

        socket.on('privateNotice', (msg) => showNotice(msg));

        function clickCard(idx) {
            if(!isMyTurn || !myHand[idx]) return;
            selectedCard = myHand[idx];
            if((selectedCard.includes("ì„¸ì") || selectedCard.includes("ì„ê¸ˆ")) && myHand.some(c => c.includes("í›„ê¶"))) return showNotice("í›„ê¶ì„ ë¨¼ì € ë²„ë ¤ì•¼ í•˜ì˜¤!");
            const targets = ["í¬ì¡¸", "ë¬´ë‹¹", "ê²€ê°", "ì„¸ì", "ì„ê¸ˆ"];
            if(targets.some(t => selectedCard.includes(t))) {
                const container = document.getElementById('target-buttons');
                container.innerHTML = "";
                players.forEach(p => {
                    const isSeja = selectedCard.includes("ì„¸ì");
                    if(!p.isEliminated && (isSeja || p.name !== myName)) {
                        const btn = document.createElement('button'); btn.className = "overlay-btn"; btn.innerText = p.name;
                        btn.onclick = () => { selectTarget(p.name); };
                        container.appendChild(btn);
                    }
                });
                if(container.innerHTML === "") selectTarget(myName); 
                else document.getElementById('target-overlay').style.display = 'flex';
            } else { selectedTarget = ""; submitPlay(); }
        }

        function selectTarget(name) {
            selectedTarget = name;
            document.getElementById('target-overlay').style.display = 'none';
            if(selectedCard.includes("í¬ì¡¸") && selectedTarget !== myName) document.getElementById('guess-overlay').style.display = 'flex';
            else submitPlay();
        }

        function submitPlay(guess = "") {
            socket.emit('playCard', { card: selectedCard, target: selectedTarget, guess: guess });
            isMyTurn = false;
            closeOverlay();
            updateHandUI();
        }

        function closeOverlay() { document.getElementById('target-overlay').style.display = 'none'; document.getElementById('guess-overlay').style.display = 'none'; }

        socket.on('updateCardStats', (data) => {
            const { stats, deckCount } = data;
            document.getElementById('deck-status').innerText = `í˜„ì¬ê¹Œì§€ ê³µê°œëœ ì¹´ë“œ (ë‚¨ì€ ë±: ${deckCount}ì¥)`;
            document.getElementById('mini-card-container').innerHTML = stats.map(s => {
                const isAllOut = s.discarded === s.total;
                const cardClass = isAllOut ? "mini-card sold-out" : "mini-card";
                const countColor = isAllOut ? "#ff5252" : "#aaa";
                return `
                    <div class="${cardClass}" onclick="showNotice('${s.emoji}${s.name}: ${cardInfo[s.num].desc}')">
                        <b>${s.emoji}</b>
                        <span>${s.name}(${s.num})</span>
                        <div style="font-size:10px; color:${countColor}; font-weight:${isAllOut ? 'bold' : 'normal'};">
                            ${s.discarded} / ${s.total}
                        </div>
                    </div>`;
            }).join("");
        });
    </script>
</body>
</html>
